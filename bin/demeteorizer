#!/usr/bin/env node

const Path = require('path');
const Program = require('commander');

const Build = require('../lib/build');
const UpdatePackage = require('../lib/update-package');

Program
  .version(require('../package.json').version)
  .option(
    '-o, --output <path>',
    'Output folder for converted application. Defaults to ./.demeteorized.')
  .option(
    '-j, --json <json>',
    'JSON data to be merged into the generated package.json')
  .parse(process.argv);

Program.output = Program.output || Path.join(process.cwd(), '.demeteorized');

if (Program.release) {
  console.log('Release:', Program.release);
}

try {
  Program.json = JSON.parse(Program.json);
} catch(e) {
  Program.json = {};
}

var options = {
  appName: Program.app_name,
  debug: Program.debug,
  input: process.cwd(),
  directory: Program.output,
  release: Program.release,
  tarball: Program.tarball,
  json: Program.json
};

console.log('Demeteorizating application...');

Build(options, function (err) {
  if (err) {
    console.error(err.message);
    return process.exit(1);
  }

  UpdatePackage(options, function (err) {
    if (err) {
      console.error(err.message);
      return process.exit(1);
    }

    console.log('Demeteorization complete.');
  });
});
